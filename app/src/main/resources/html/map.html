<!DOCTYPE html>
<html>

<head>
    <title>Leaflet & OSM Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="../styles/popup.css">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }
    </style>
    <style>
        .custom-div-icon {
            position: relative;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            /* makes the teardrop shape */
            transform: rotate(-45deg);
            /* rotates to point downwards */
            position: absolute;
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            border: 1px solid #000;
        }

        /* image overlay */
        .marker-img {
            position: absolute;
            width: 18px;
            height: 18px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-size: cover;
            background-position: center;
            /* make image circular */
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        let map;
        var javaScriptBridge;
        let activeMarker = null; // for single trail (when adding/editing/viewing trail)
        var markers = new L.MarkerClusterGroup();

        /**
         * This object can be returned to our java code, where we can call the functions we define inside it
         */
        let jsConnector = {
            addMarker: addMarker,
            initMap: initMap,
            enableClick: enableClick,
            clearMarkers: clearMarkers,
            displayTrails: displayTrails,
            buildPopupContent: buildPopupContent,
            openTrailInfo: openTrailInfo,
            normalizeLng: normalizeLng
        };

        /**
         * creates and initialises the map
         * @param lat the latitude that the map will be centered on when initialised
         * @param lng the longitude that the map will be centered on when initialised
         */
        function initMap(lat, lng) {
            var mapOptions = {
                center: [lat, lng],
                zoom: 10
            }
            map = new L.map('map', mapOptions);
            new L.TileLayer('https://tile.csse.canterbury.ac.nz/hot/{z}/{x}/{y}.png', { // UCs tilemap server
                attribution: 'Â© OpenStreetMap contributors<br>Served by University of Canterbury'
            }).addTo(map)
        }

        /**
         * Adds a marker to the map and stores it in the markers array for later use (e.g. removal)
         * @param lat latitude to place marker at
         * @param lng longitude to place marker at
         * @param trailJson the trail that the marker will be displayed for
         */
        function addMarker(lat, lng, trailJson, trailCompletionTime) {
            let trail = null;
            if (trailJson) {
                trail = JSON.parse(trailJson);
            }
            [lat, lng] = normalizeLng(lat, lng);
            if (activeMarker) {
                // Move existing marker instead of adding new
                activeMarker.setLatLng([lat, lng]);
            } else {
                // First time: create marker and zoom to it
                activeMarker = new L.Marker([lat, lng]).addTo(map);
                map.setView([lat, lng], 13);
            }
            if (trail) {
                activeMarker.bindPopup(buildPopupContent(trail, trailCompletionTime));
            }
        }

        /**
         * defines on click event that calls java code
         */
        function enableClick() {
            map.on("click", (map_event) => {
                var latlng = map.mouseEventToLatLng(map_event.originalEvent);
                const [lat, lng] = normalizeLng(latlng.lat, latlng.lng);
                javaScriptBridge.addMarkerFromClick(`{"lat": ${lat}, "lng": ${lng}}`)
            })
        }

        /**
         *Removes all markers currently stored in the MarkerClusterGroup markers
         * from the map.
         * This does not affect the activeMarker
         */
        function clearMarkers() {
            markers.clearLayers();
        }

        /**
         * Displays a list of trails on the map as coloured custom icons.
         * Each trail is represented by an icon whose colour is determined by
         * the trail's difficulty. The currently active marker is not modified
         * @param trailsJson a JSON string representing an array of trail objects
         */
        function displayTrails(trailsJson) {
            markers.clearLayers(); // clear the cluster group before adding new markers

            const trails = JSON.parse(trailsJson);

            trails.forEach(trail => {
                // skip the active marker so it shows as a pin
                if (activeMarker &&
                    activeMarker.getLatLng().lat === trail.lat &&
                    activeMarker.getLatLng().lng === trail.lon) {
                    return;
                }

                const difficultyClass = `legend-${['expert','advanced','intermediate','easy','easiest'].includes((trail.difficulty || '').toLowerCase())
                    ? trail.difficulty.toLowerCase()
                    : 'default'}`;

                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="marker-pin ${difficultyClass}"></div>
                        <div class="marker-img" style="background-image:url('../images/trail.png');"></div>
                `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 42],
                    popupAnchor: [0, -42]
                });

                const [lat, lng] = normalizeLng(trail.lat, trail.lon);
                const marker = L.marker([lat, lng], { icon: customIcon });
                marker.bindPopup(buildPopupContent(trail, trail.completionTime));
                markers.addLayer(marker);
            });

            map.addLayer(markers);

            let bounds = null;
            // Auto-zoom to fit all markers
            if (markers.getLayers().length > 0) {
                bounds = markers.getBounds();
                bounds.extend(activeMarker.getLatLng());
                map.fitBounds(bounds);
            }
        }

        /**
         * Normalizes a longitude to the instance of the world closest to the current map center so Chatham Islands
         * does not wrap around
         * @param lat the latitude of the point
         * @param lng the longitude of the point to normalize
         * @returns {*[]} An array containing the latitude and the normalized longitude
         */
        function normalizeLng(lat, lng) {
            while (lng - map.getCenter().lng > 180) lng -= 360;
            while (lng - map.getCenter().lng < -180) lng += 360;
            return [lat, lng];
        }

        /**
         * Builds the popup content for a given trail. No link is shown for the marker that the user is viewing a trail for
         * @param trail the trail object
         * @param trailCompletionTime the trail completion time that has been formatted
         * @returns {string} HTML string for the popup
         */
        function buildPopupContent(trail, trailCompletionTime) {
            const isActive =
                activeMarker &&
                activeMarker.getLatLng().lat === trail.lat &&
                activeMarker.getLatLng().lng === trail.lon;

            return `
            <div class = "heading">${trail.name}</div>
            <div class = "label">${trail.region}</div>
            <div class = "container">
                ${trail.difficulty && trail.difficulty.trim().toLowerCase() != "unknown" && trail.difficulty.trim() != "" ?
                `<div class = "pill bg-pinky">${trail.difficulty}</div>` : ""}
                ${trailCompletionTime && trailCompletionTime.trim().toLowerCase() != "unknown" && trailCompletionTime.trim() != "" ?
                `<div class = "pill bg-bluey">${trailCompletionTime}</div>` : ""}
                ${trail.completionType && trail.completionType.trim().toLowerCase() !== "unknown" && trail.completionType.trim() != "" ?
                `<div class = "pill bg-greeny">${trail.completionType}</div>` : ""}
            </div>
            ${!isActive ? `<a href="#" onclick="openTrailInfo(${trail.id}); return false;">View details</a>` : ""}
        `;
        }

        /**
         * Attempts to open the ViewTrail page for a trail with the given id
         * @param trailId the id for the trail whose page should be opened
         */
        function openTrailInfo(trailId) {
            if (javaScriptBridge && javaScriptBridge.openTrailInfo) {
                javaScriptBridge.openTrailInfo(trailId);
            } else {
                console.log("Trail ID clicked:", trailId);
            }
        }

    </script>
</body>

</html>